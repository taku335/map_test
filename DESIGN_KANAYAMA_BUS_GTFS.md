# 金山駅周辺バス停・時刻表表示機能 設計書

- 作成日: 2026-02-16
- 対象システム: `/Users/taku/dev/map_test`
- 対象画面: 地図画面（Leaflet）

## 1. 目的
愛知県名古屋市の金山駅周辺を対象に、GTFS静的データを用いてバス停と路線を地図表示し、停留所クリックで時刻表を参照できる機能を提供する。

## 2. スコープ
本機能で対応する範囲は以下とする。

1. 金山駅中心の半径5km圏にあるバス停の表示
2. バス路線ポリラインの表示
3. 停留所クリック時の右サイドパネル表示
4. 時刻表の表示
5. デフォルト表示は当日かつ現在時刻以降
6. 日付変更（`YYYY-MM-DD`）による別日の参照
7. 停留所名検索

## 3. データソース
名古屋市公式オープンデータ（BODIK/CKAN）の「市バスGTFS-JPデータ」を使用する。

- データセット: https://data.bodik.jp/dataset/231002_7109030000_bus-gtfs-jp
- リソース例（2025-03-29改正）: https://data.bodik.jp/dataset/231002_7109030000_bus-gtfs-jp/resource/90ceab55-f14f-4376-8c7a-088fcb49115e
- 交通局案内: https://www.kotsu.city.nagoya.jp/jp/pc/ABOUT/TRP0000777.htm

運用では固定ZIP直リンクをハードコードせず、CKAN APIから最新リソースURLを取得して解決する方式を採用する。

## 4. 機能要件

### 4.1 地図表示
1. 初期中心座標は金山駅付近（例: `35.1432528, 136.9009513`）。
2. 半径5kmの範囲リングを地図上に表示する。
3. 対象停留所は半径5km内のみ初期表示する。
4. 既存の路線ポリライン表示は継続する。

### 4.2 交通モード制約
1. バスのみを対象とする。
2. GTFS `routes.txt` の `route_type=3` を基準にフィルタする。

### 4.3 停留所操作と時刻表表示
1. 停留所マーカークリックで右サイドパネルを開く。
2. 同名停留所が複数あっても、クリックした `stop_id` のみ表示する。
3. サイドパネルには次の2タブを表示する。
4. `次の10件`
5. `その日の全便`
6. 時刻表項目は以下を表示する。
7. 発車時刻
8. 行先（trip headsign）
9. 路線名（short/long name）

### 4.4 日付・時刻条件
1. 日付入力は `YYYY-MM-DD`（時刻入力なし）。
2. 当日選択時は「現在時刻以降」の便のみ表示する。
3. 当日以外は「その日0:00以降」の便を表示する。

### 4.5 検索
1. 停留所名検索ボックスを提供する。
2. 検索候補選択で対象停留所へ地図移動し、時刻表を表示する。

## 5. 読み込み対象GTFSファイル
1. `stops.txt`
2. `routes.txt`
3. `trips.txt`
4. `stop_times.txt`
5. `calendar.txt`
6. `calendar_dates.txt`
7. `shapes.txt`

## 6. データ処理設計

### 6.1 前処理
1. ZIP展開後、各TXTをCSVパースする。
2. `route_type=3` の `route_id` 集合を作成する。
3. 対象 `route_id` に紐づく `trip_id` 集合を作成する。
4. 対象 `trip_id` に紐づく `stop_times` と `shape_id` を抽出する。

### 6.2 インデックス構築
1. `tripById`: `trip_id -> { route_id, service_id, trip_headsign, shape_id }`
2. `routeById`: `route_id -> { route_short_name, route_long_name, route_color }`
3. `timesByStopId`: `stop_id -> stop_times[]`（時刻昇順）
4. `serviceCalendar`: `service_id -> 運行判定情報`

### 6.3 運行日判定
1. 基本判定は `calendar.txt` の曜日・適用期間で行う。
2. `calendar_dates.txt` の追加（exception_type=1）と除外（exception_type=2）で上書きする。
3. 選択日ごとに有効 `service_id` を算出する。

### 6.4 時刻フィルタ
1. 停留所選択時、`timesByStopId[stop_id]` から対象便を取得する。
2. 選択日の有効 `service_id` のみ残す。
3. 当日なら現在時刻未満を除外する。
4. `次の10件` は先頭10件を表示する。
5. `その日の全便` は全件を表示する。
6. GTFSの24時超え時刻（例: `25:10:00`）を扱えるロジックにする。

## 7. UI設計

### 7.1 画面構成
1. ヘッダー
2. 検索バー（停留所名）
3. 地図（Leaflet）
4. 右サイドパネル（時刻表）

### 7.2 サイドパネル要素
1. 選択停留所名
2. 日付入力（`YYYY-MM-DD`）
3. タブ
4. `次の10件`
5. `その日の全便`
6. 時刻表リスト
7. 空状態メッセージ
8. エラーメッセージ

## 8. エラー処理・例外
1. GTFS取得失敗時は地図上またはパネルに失敗メッセージを表示。
2. 選択停留所に便がない場合は「該当便なし」を表示。
3. 必須GTFSファイル欠落時は処理停止し理由を表示。
4. CSV不正行はスキップし、処理継続可能な場合は継続する。

## 9. パフォーマンス方針
1. 起動時にインデックスを構築し、クリック時の再計算を最小化する。
2. 停留所検索は前方一致または部分一致で実装し、候補件数を制限する。
3. ルート描画は対象バス路線に限定する。

## 10. 実装ステップ
1. GTFS取得を最新リソース解決方式に変更
2. 読み込み対象ファイルを拡張
3. バス路線フィルタとインデックス構築を実装
4. 運行日判定ロジックを実装
5. サイドパネルUI（2タブ・日付入力）を実装
6. 停留所クリック連携を実装
7. 停留所検索を実装
8. 5kmフィルタと範囲リングを実装
9. エラー表示と空状態表示を実装

## 11. 受け入れ条件
1. 金山駅中心5km内のバス停が表示される。
2. バス路線ポリラインが表示される。
3. 停留所クリックで右サイドパネルに時刻表が表示される。
4. 当日は現在時刻以降のみ表示される。
5. 日付変更で任意日の時刻表が表示される。
6. `次の10件` と `その日の全便` が切り替え可能である。
7. 停留所検索から対象停留所へ遷移できる。

